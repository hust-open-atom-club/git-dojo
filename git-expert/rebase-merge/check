#!/opt/pwn.college/bash

# 检查 /tmp/repo 是否存在且为目录
if [ ! -d /tmp/repo ]; then
    echo "[-] 不要删除 /tmp/repo 文件夹！"
    exit 1
fi

cd /tmp/repo

sudo -u hacker git checkout master

# 检查是否包含 feature 分支的提交信息（假设通过提交信息匹配）
if ! sudo -u hacker git log --oneline | grep -q "Add line 3 on feature"; then
    echo "[-] 缺少 feature 分支上的提交"
    exit 1
fi

if ! sudo -u hacker git log --oneline | grep -q "Add line 4 on feature"; then
    echo "[-] 缺少 feature 分支上的提交"
    exit 1
fi

# 检查是否为线性历史（无 merge commit）
if sudo -u hacker git log --merges | grep .; then
    echo "[-] 发现 merge commit，请使用 rebase 代替 merge"
    exit 1
fi

# 检查文件最终内容是否完整
expected="Line 1
Line 2
Line 3 from feature
Line 4 from feature"
actual=$(cat /tmp/repo/file.txt)

if [[ "$actual" != "$expected" ]]; then
    echo "[-] file.txt 内容不正确，请确保合并顺序和内容正确"
    exit 1
fi

echo "[+] 恭喜你成功完成了线性合并任务，这是你的 flag："
cat /flag
